<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Producción - Cirineo 2025</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        // Utilidades simples de fecha para no depender de librerías externas pesadas
        const DateUtils = {
            formatID: (date) => date.toISOString().split('T')[0], // YYYY-MM-DD
            addDays: (date, days) => { const d = new Date(date); d.setDate(d.getDate() + days); return d; },
            startOfWeek: (date) => { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)); }, // Lunes como inicio
            formatDisplay: (dateStr) => {
                const d = new Date(dateStr + 'T12:00:00'); // Forzar medio día para evitar timezone shifts
                const days = ['DOMINGO', 'LUNES', 'MARTES', 'MIERCOLES', 'JUEVES', 'VIERNES', 'SABADO'];
                const months = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
                return `${days[d.getDay()]} ${d.getDate()} ${months[d.getMonth()]}`;
            },
            getMonthMatrix: (year, month) => {
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Ajuste para Lunes=0
                const days = [];
                // Rellenar vacíos iniciales
                for(let i=0; i<startDay; i++) days.push(null);
                // Días del mes
                for(let i=1; i<=lastDay.getDate(); i++) days.push(new Date(year, month, i));
                return days;
            }
        };
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .machine-col { min-width: 100px; width: 100px; }
        .machine-col.expanded { min-width: 220px; width: 220px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const { useState, useEffect, useMemo, useCallback } = React;

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- CONFIGURACIÓN ---
        const ROLES = { ADMIN: 'admin', COMMENTATOR: 'commentator', OBSERVER: 'observer', OPERATOR: 'operator' };
        const USERS = {
            '1111': { name: 'Marco Espinoza', role: ROLES.ADMIN },
            '0000': { name: 'Prisciliano Espinoza', role: ROLES.COMMENTATOR },
            '2222': { name: 'Susana', role: ROLES.OBSERVER },
            '3333': { name: 'Operadores', role: ROLES.OPERATOR },
        };
        const MACHINES = [
            { id: 'm35', name: 'MAQ 35', type: 'SANTONI SM8 TOP 2V', diam: 16 },
            { id: 'm39', name: 'MAQ 39', type: 'SANTONI SM8 TOP 2V', diam: 16 },
            { id: 'm40', name: 'MAQ 40', type: 'SANTONI SM8 TOP 2V', diam: 16 },
            { id: 'm36', name: 'MAQ 36', type: 'CIXING GE82', diam: 15 },
            { id: 'm38', name: 'MAQ 38', type: 'SANTONI SM8 TOP 2V', diam: 15 },
            { id: 'm37', name: 'MAQ 37', type: 'SANTONI SM8 TOP 2V', diam: 15 },
            { id: 'm29', name: 'MAQ 29', type: 'SANTONI SM8 EVO 4', diam: 16 },
            { id: 'm28', name: 'MAQ 28', type: 'SANTONI SM8 EVO 4', diam: 16 },
            { id: 'm27', name: 'MAQ 27', type: 'SANTONI SM8 EVO 4', diam: 15 },
            { id: 'm33', name: 'MAQ 33', type: 'SANTONI SM8 EVO 4', diam: 15 },
            { id: 'm1',  name: 'MAQ 1',  type: 'CIXING', diam: 14 },
            { id: 'm30', name: 'MAQ 30', type: 'CIXING GE82', diam: 14 },
            { id: 'm31', name: 'MAQ 31', type: 'CIXING GE82', diam: 14 },
            { id: 'm6',  name: 'MAQ 6',  type: 'CIXING GE82', diam: 14 },
            { id: 'm32', name: 'MAQ 32', type: 'CIXING GE82', diam: 14 },
            { id: 'm13', name: 'MAQ 13', type: 'SANTONI SM8 EVO 4', diam: 13 },
            { id: 'm12', name: 'MAQ 12', type: 'SANTONI SM8 EVO 4', diam: 13 },
            { id: 'm24', name: 'MAQ 24', type: 'SANTONI SM8 EVO 4', diam: 13 },
            { id: 'm8',  name: 'MAQ 8',  type: 'SANTONI SM8 TOP 2', diam: 13 },
        ];

        // --- COMPONENTES AUXILIARES ---
        const MachineIcon = () => (
            <img src="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.png" className="w-full h-full object-contain" onError={(e) => e.target.style.display='none'} />
        );

        // --- PANTALLA DE LOGIN ---
        const Login = ({ onLogin }) => {
            const [pin, setPin] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (USERS[pin]) onLogin(USERS[pin]);
                else setError('PIN no reconocido');
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-4 shadow-lg shadow-blue-200">
                                <i data-lucide="layout-grid" className="w-8 h-8"></i>
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800">Cirineo Producción</h1>
                            <p className="text-slate-500">Sistema de Control 2025</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input 
                                type="password" 
                                value={pin} 
                                onChange={e => setPin(e.target.value)} 
                                maxLength="4" 
                                className="w-full text-center text-4xl tracking-widest font-bold text-slate-800 border-2 border-slate-200 rounded-xl p-4 focus:border-blue-500 focus:outline-none transition-colors"
                                placeholder="••••"
                            />
                            {error && <p className="text-red-500 text-center text-sm font-medium">{error}</p>}
                            <button className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-800 transition shadow-lg">INGRESAR</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- MODAL DE PLANIFICACIÓN ---
        const PlanningModal = ({ isOpen, onClose, machine, rowId, initialData, onSave, onMigrate }) => {
            if (!isOpen) return null;
            
            const [data, setData] = useState({
                model: initialData?.plan_model || '',
                target: initialData?.plan_target_qty || '',
                time: initialData?.plan_time_min || '',
                hours: initialData?.plan_hours || 24
            });
            const [mode, setMode] = useState('edit'); // 'edit' or 'migrate'

            const handleSave = () => {
                onSave(rowId, machine.id, {
                    plan_model: data.model,
                    plan_target_qty: Number(data.target),
                    plan_time_min: Number(data.time),
                    plan_hours: Number(data.hours)
                });
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="bg-slate-900 text-white p-4 flex justify-between items-center">
                            <h3 className="font-bold flex items-center gap-2"><i data-lucide="settings-2" className="w-5 h-5"></i> {machine.name}</h3>
                            <button onClick={onClose}><i data-lucide="x" className="w-5 h-5"></i></button>
                        </div>
                        
                        {mode === 'edit' ? (
                            <div className="p-6 space-y-4">
                                <div className="text-xs text-slate-400 font-mono text-center mb-2">{DateUtils.formatDisplay(rowId)}</div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase">Modelo</label>
                                    <input type="text" className="w-full border rounded-lg p-2 font-bold text-slate-800" value={data.model} onChange={e => setData({...data, model: e.target.value})} placeholder="Ej: B001" />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase">Meta (Pzas)</label>
                                        <input type="number" className="w-full border rounded-lg p-2" value={data.target} onChange={e => setData({...data, target: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase">Min/Pza</label>
                                        <input type="number" className="w-full border rounded-lg p-2" value={data.time} onChange={e => setData({...data, time: e.target.value})} />
                                    </div>
                                </div>
                                <div className="flex gap-2 pt-4">
                                    <button onClick={handleSave} className="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700">Guardar Plan</button>
                                    <button onClick={() => setMode('migrate')} className="px-4 bg-indigo-100 text-indigo-700 rounded-xl font-bold"><i data-lucide="arrow-right-left" className="w-5 h-5"></i></button>
                                </div>
                            </div>
                        ) : (
                            <div className="p-6">
                                <h4 className="font-bold text-slate-800 mb-4">Migrar Pedido a otra máquina</h4>
                                <div className="grid grid-cols-3 gap-2 max-h-60 overflow-y-auto">
                                    {MACHINES.filter(m => m.id !== machine.id).map(m => (
                                        <button key={m.id} onClick={() => { onMigrate(rowId, m.id, data); onClose(); }} className="text-xs p-2 border rounded hover:bg-blue-50 text-left">
                                            <b>{m.name}</b>
                                        </button>
                                    ))}
                                </div>
                                <button onClick={() => setMode('edit')} className="w-full mt-4 text-slate-500 text-sm">Cancelar</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE: TABLA DE PRODUCCIÓN ---
        const ProductionTable = ({ startDate, productionData, onUpdate, userRole, openPlanning }) => {
            const [expandedMachine, setExpandedMachine] = useState(null);

            // Generar 7 días a partir de la fecha de inicio
            const rows = useMemo(() => {
                const r = [];
                let d = new Date(startDate);
                for (let i = 0; i < 7; i++) {
                    r.push(DateUtils.formatID(d));
                    d.setDate(d.getDate() + 1);
                }
                return r;
            }, [startDate]);

            // Lógica de "Cascada Temporal"
            const getMachineState = (rowId, machineId) => {
                // 1. Datos directos del día
                const directData = productionData[rowId]?.[machineId] || {};
                
                // 2. Si hay plan hoy, úsalo. Si no, BUSCA HACIA ATRÁS en toda la BBDD.
                let activePlan = directData.plan_model ? directData : null;
                let accumulated = 0;

                if (!activePlan) {
                    // Buscar el plan más reciente anterior a esta fecha
                    const allDates = Object.keys(productionData).sort();
                    const currentIndex = allDates.indexOf(rowId);
                    
                    // Buscar hacia atrás desde la fecha actual (o desde el final si la fecha no existe aun)
                    let searchLimit = currentIndex === -1 ? allDates.length - 1 : currentIndex - 1;
                    
                    for (let i = searchLimit; i >= 0; i--) {
                        const prevDate = allDates[i];
                        if (prevDate >= rowId) continue; // Seguridad
                        
                        const prevData = productionData[prevDate]?.[machineId];
                        if (prevData?.plan_model) {
                            activePlan = prevData;
                            break; // Encontramos el padre
                        }
                    }
                }

                // Calcular acumulado sumando producciones desde la fecha del plan hasta ayer
                if (activePlan) {
                    // Encontrar fecha de inicio del plan
                    // Nota: Esto es costoso computacionalmente en producción real, aquí es simulación
                    Object.keys(productionData).forEach(date => {
                        // Si la fecha es >= fecha plan y <= fecha actual
                         // (Simplificación para demo: sumamos todo lo que coincida con el modelo en fechas previas)
                         // Una implementación real requiere guardar el ID del plan.
                         // Aquí sumaremos 'actual' si el modelo coincide para evitar sumar de otros pedidos
                         const cell = productionData[date]?.[machineId];
                         if (date <= rowId && cell?.plan_model === activePlan.plan_model) {
                             accumulated += (cell.actual || 0);
                         } else if (date <= rowId && !cell?.plan_model && activePlan) {
                             // Si es un día heredado, asume que es el mismo pedido
                             // (Lógica simplificada de herencia)
                             // Para hacerlo robusto: Buscamos plan padre de 'date' y si es el mismo 'activePlan', sumamos.
                         }
                    });
                }

                return {
                    ...directData,
                    displayPlan: activePlan,
                    accumulatedTotal: accumulated // (Este valor es aproximado en esta demo simple)
                };
            };

            return (
                <div className="flex-1 overflow-auto bg-white rounded-xl shadow border border-slate-200 custom-scrollbar relative">
                    <table className="w-full border-collapse">
                        <thead className="bg-slate-50 sticky top-0 z-20 shadow-sm">
                            <tr>
                                <th className="p-3 text-left min-w-[120px] text-xs font-bold text-slate-500 border-r">FECHA</th>
                                {MACHINES.map(m => (
                                    <th key={m.id} className={`machine-col ${expandedMachine === m.id ? 'expanded' : ''} p-2 border-r transition-all align-top`}>
                                        <button onClick={() => setExpandedMachine(expandedMachine === m.id ? null : m.id)} className="w-full flex flex-col items-center">
                                            <div className="w-8 h-8 opacity-80"><MachineIcon /></div>
                                            <span className="text-xs font-bold text-blue-900 mt-1">{m.name.replace('MAQ ','')}</span>
                                            {expandedMachine === m.id && <span className="text-[10px] text-slate-400">{m.type}</span>}
                                        </button>
                                    </th>
                                ))}
                            </tr>
                        </thead>
                        <tbody>
                            {rows.map(dateId => (
                                <tr key={dateId} className="border-b border-slate-100 hover:bg-slate-50/80 transition-colors">
                                    <td className="p-3 border-r bg-white sticky left-0 z-10 text-xs font-bold text-slate-600 whitespace-nowrap shadow-[2px_0_5px_rgba(0,0,0,0.05)]">
                                        {DateUtils.formatDisplay(dateId)}
                                    </td>
                                    {MACHINES.map(m => {
                                        const cell = getMachineState(dateId, m.id);
                                        const hasPlan = !!cell.displayPlan;
                                        const isExpanded = expandedMachine === m.id;
                                        const canEdit = userRole !== ROLES.OBSERVER;
                                        const isAdmin = userRole === ROLES.ADMIN;

                                        return (
                                            <td key={m.id} className={`p-1 border-r relative transition-all ${isExpanded ? 'bg-blue-50/30' : ''}`}>
                                                <div className="flex flex-col gap-1 h-full min-h-[50px]">
                                                    
                                                    {/* Plan Info */}
                                                    <div className={`text-[10px] p-1 rounded flex justify-between items-start ${hasPlan ? 'bg-blue-100/50 text-blue-800' : ''}`}>
                                                        {hasPlan ? (
                                                            <div className="overflow-hidden">
                                                                <div className="font-bold truncate max-w-[80px]" title={cell.displayPlan.plan_model}>{cell.displayPlan.plan_model}</div>
                                                                {isExpanded && (
                                                                    <div className="text-slate-500 leading-tight mt-1">
                                                                        Meta: {cell.displayPlan.plan_target_qty}<br/>
                                                                        Turno: {cell.displayPlan.plan_hours}h
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ) : <span className="text-slate-300">-</span>}
                                                        
                                                        {isAdmin && (
                                                            <button onClick={() => openPlanning(m, dateId, cell)} className="text-slate-400 hover:text-blue-600">
                                                                <i data-lucide={hasPlan && cell.plan_model ? "edit-2" : "plus"} className="w-3 h-3"></i>
                                                            </button>
                                                        )}
                                                    </div>

                                                    {/* Input Producción */}
                                                    <input 
                                                        type="number" 
                                                        value={cell.actual || ''} 
                                                        onChange={(e) => canEdit && onUpdate(dateId, m.id, { actual: Number(e.target.value) })}
                                                        placeholder="-"
                                                        className={`w-full text-center font-bold text-sm bg-transparent outline-none py-1 rounded ${canEdit ? 'hover:bg-white focus:bg-white focus:ring-2 ring-blue-200' : ''}`}
                                                        readOnly={!canEdit}
                                                    />
                                                </div>
                                            </td>
                                        );
                                    })}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        // --- DASHBOARD ADMIN (Calendario y Resumen) ---
        const AdminDashboard = ({ user, productionData, onUpdate, openPlanning }) => {
            const [viewDate, setViewDate] = useState(new Date()); // Fecha seleccionada para el calendario
            const [selectedStartWeek, setSelectedStartWeek] = useState(DateUtils.startOfWeek(new Date())); // Fecha inicio tabla

            // Estadísticas (Mockup basado en datos reales)
            const stats = useMemo(() => {
                let totalToday = 0;
                const todayId = DateUtils.formatID(new Date());
                Object.values(productionData[todayId] || {}).forEach(m => totalToday += (m.actual || 0));
                return { totalToday, activeMachines: 18 }; // Simplificado
            }, [productionData]);

            // Navegación Calendario
            const changeMonth = (delta) => {
                const newDate = new Date(viewDate.getFullYear(), viewDate.getMonth() + delta, 1);
                setViewDate(newDate);
            };

            const calendarDays = DateUtils.getMonthMatrix(viewDate.getFullYear(), viewDate.getMonth());

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    {/* Header Admin */}
                    <header className="bg-slate-900 text-white p-4 flex justify-between items-center shadow-md z-30">
                        <div className="flex items-center gap-4">
                            <div className="bg-blue-600 p-2 rounded-lg"><i data-lucide="layout-dashboard" className="w-6 h-6"></i></div>
                            <div>
                                <h1 className="text-xl font-bold">Panel Global</h1>
                                <p className="text-xs text-slate-400">Bienvenido, {user.name}</p>
                            </div>
                        </div>
                        <div className="flex gap-4 text-right">
                            <div>
                                <p className="text-xs text-slate-400 uppercase font-bold">Producción Hoy</p>
                                <p className="text-xl font-bold text-green-400">{stats.totalToday.toLocaleString()} Pzas</p>
                            </div>
                            <button onClick={() => location.reload()} className="bg-red-500/20 hover:bg-red-500 p-2 rounded-lg transition"><i data-lucide="log-out" className="w-5 h-5"></i></button>
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        {/* Sidebar: Calendario de Navegación */}
                        <aside className="w-80 bg-white border-r border-slate-200 flex flex-col z-20 shadow-lg">
                            <div className="p-4 border-b">
                                <div className="flex justify-between items-center mb-4">
                                    <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-slate-100 rounded"><i data-lucide="chevron-left" className="w-5 h-5"></i></button>
                                    <span className="font-bold text-slate-800 uppercase">{viewDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</span>
                                    <button onClick={() => changeMonth(1)} className="p-1 hover:bg-slate-100 rounded"><i data-lucide="chevron-right" className="w-5 h-5"></i></button>
                                </div>
                                <div className="grid grid-cols-7 text-center text-xs font-bold text-slate-400 mb-2">
                                    <span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span><span>D</span>
                                </div>
                                <div className="grid grid-cols-7 gap-1">
                                    {calendarDays.map((d, i) => {
                                        if (!d) return <div key={i}></div>;
                                        const isSelected = DateUtils.formatID(d) === DateUtils.formatID(selectedStartWeek);
                                        const isToday = DateUtils.formatID(d) === DateUtils.formatID(new Date());
                                        return (
                                            <button 
                                                key={i} 
                                                onClick={() => setSelectedStartWeek(DateUtils.startOfWeek(d))}
                                                className={`h-8 w-8 rounded-full text-xs font-medium flex items-center justify-center transition 
                                                    ${isSelected ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-slate-100 text-slate-700'}
                                                    ${isToday && !isSelected ? 'border border-blue-600 text-blue-600' : ''}
                                                `}
                                            >
                                                {d.getDate()}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                            
                            <div className="p-4 flex-1 bg-slate-50">
                                <h3 className="text-xs font-bold text-slate-500 uppercase mb-3">Accesos Rápidos</h3>
                                <button onClick={() => setSelectedStartWeek(DateUtils.startOfWeek(new Date()))} className="w-full mb-2 bg-white border border-slate-200 p-3 rounded-lg flex items-center gap-3 text-sm font-bold text-slate-700 hover:shadow-md transition">
                                    <i data-lucide="calendar-check" className="w-4 h-4 text-blue-500"></i> Ir a Hoy
                                </button>
                                <button onClick={() => setSelectedStartWeek(DateUtils.startOfWeek(new Date(new Date().getFullYear() + 1, 0, 1)))} className="w-full bg-white border border-slate-200 p-3 rounded-lg flex items-center gap-3 text-sm font-bold text-slate-700 hover:shadow-md transition">
                                    <i data-lucide="calendar-days" className="w-4 h-4 text-purple-500"></i> Próximo Año
                                </button>
                            </div>
                        </aside>

                        {/* Área Principal: Tabla */}
                        <main className="flex-1 flex flex-col bg-slate-100 p-4 min-w-0">
                            <div className="mb-2 flex justify-between items-end">
                                <h2 className="text-lg font-bold text-slate-700 flex items-center gap-2">
                                    <i data-lucide="list" className="w-5 h-5"></i>
                                    Semana del {DateUtils.formatDisplay(DateUtils.formatID(selectedStartWeek))}
                                </h2>
                            </div>
                            <ProductionTable 
                                startDate={selectedStartWeek} 
                                productionData={productionData}
                                onUpdate={onUpdate}
                                userRole={user.role}
                                openPlanning={openPlanning}
                            />
                        </main>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD OPERADOR (Simple) ---
        const OperatorView = ({ user, productionData, onUpdate }) => {
            const currentWeekStart = DateUtils.startOfWeek(new Date());

            return (
                <div className="h-screen flex flex-col bg-slate-50">
                    <header className="bg-white p-4 border-b flex justify-between items-center sticky top-0 z-30">
                        <div>
                            <h1 className="text-lg font-bold text-slate-800">Control de Piso</h1>
                            <p className="text-xs text-slate-500">{user.name}</p>
                        </div>
                        <button onClick={() => location.reload()} className="text-red-500 font-bold text-sm">SALIR</button>
                    </header>
                    <main className="flex-1 p-2 overflow-hidden flex flex-col">
                        <ProductionTable 
                            startDate={currentWeekStart} 
                            productionData={productionData}
                            onUpdate={onUpdate}
                            userRole={user.role}
                            openPlanning={() => {}} // Operadores no planean
                        />
                    </main>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [productionData, setProductionData] = useState({});
            const [loading, setLoading] = useState(true);
            const [modalConfig, setModalConfig] = useState(null); // { isOpen, machine, rowId, initialData }

            // Iconos
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            // Auth
            useEffect(() => {
                const unsub = onAuthStateChanged(auth, u => {
                    if(u) {
                        const q = collection(db, 'produccion_2025');
                        onSnapshot(q, snap => {
                            const d = {};
                            snap.forEach(doc => d[doc.id] = doc.data());
                            setProductionData(d);
                            setLoading(false);
                        });
                    } else {
                        signInAnonymously(auth);
                    }
                });
                return () => unsub();
            }, []);

            const handleUpdate = useCallback(async (rowId, machineId, data) => {
                if(!user) return;
                try {
                    const ref = doc(db, 'produccion_2025', rowId);
                    const updatePayload = {};
                    Object.keys(data).forEach(k => updatePayload[`${machineId}.${k}`] = data[k]);
                    await setDoc(ref, updatePayload, { merge: true });
                } catch(e) { console.error(e); }
            }, [user]);

            const handleMigrate = (sourceRowId, targetMachineId, planData) => {
                // Migra el plan al MISMO día pero otra máquina
                handleUpdate(sourceRowId, targetMachineId, {
                    plan_model: planData.model,
                    plan_target_qty: Number(planData.target), // Aquí podría ir lógica de remanente
                    plan_time_min: Number(planData.time),
                    plan_hours: 24,
                    migratedFrom: sourceRowId // Flag opcional
                });
            };

            if (!user) return <Login onLogin={setUser} />;
            if (loading) return <div className="h-screen flex items-center justify-center text-blue-600 font-bold">CARGANDO...</div>;

            const isPowerUser = [ROLES.ADMIN, ROLES.COMMENTATOR].includes(user.role);

            return (
                <>
                    {isPowerUser ? (
                        <AdminDashboard 
                            user={user} 
                            productionData={productionData} 
                            onUpdate={handleUpdate}
                            openPlanning={(machine, rowId, cell) => setModalConfig({ isOpen: true, machine, rowId, initialData: cell })}
                        />
                    ) : (
                        <OperatorView 
                            user={user} 
                            productionData={productionData} 
                            onUpdate={handleUpdate}
                        />
                    )}

                    <PlanningModal 
                        isOpen={modalConfig?.isOpen}
                        onClose={() => setModalConfig(null)}
                        machine={modalConfig?.machine}
                        rowId={modalConfig?.rowId}
                        initialData={modalConfig?.initialData}
                        onSave={handleUpdate}
                        onMigrate={handleMigrate}
                    />
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
