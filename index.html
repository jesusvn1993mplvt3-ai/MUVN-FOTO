<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Producción - Cirineo 2025/2026</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .machine-col { min-width: 100px; width: 100px; }
        .machine-col.expanded { min-width: 200px; width: 200px; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const { useState, useEffect, useMemo, useCallback } = React;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONSTANTES ---
        const ROLES = {
            ADMIN: 'admin', 
            COMMENTATOR: 'commentator', 
            OBSERVER: 'observer', 
            OPERATOR: 'operator', 
        };

        const USERS = {
            '1111': { name: 'Marco Espinoza', role: ROLES.ADMIN, id: 'marco' },
            '0000': { name: 'Prisciliano Espinoza', role: ROLES.COMMENTATOR, id: 'prisciliano' },
            '2222': { name: 'Susana', role: ROLES.OBSERVER, id: 'susana' },
            '3333': { name: 'Operadores', role: ROLES.OPERATOR, id: 'operadores' },
        };
        
        const MACHINES = [
            { id: 'm35', name: 'MAQ 35', type: 'SANTONI SM8 TOP 2V', diam: 16, needles: 1440, gauge: 28 },
            { id: 'm39', name: 'MAQ 39', type: 'SANTONI SM8 TOP 2V', diam: 16, needles: 1440, gauge: 28 },
            { id: 'm40', name: 'MAQ 40', type: 'SANTONI SM8 TOP 2V', diam: 16, needles: 1440, gauge: 28 },
            { id: 'm36', name: 'MAQ 36', type: 'CIXING GE82', diam: 15, needles: 1344, gauge: 28 },
            { id: 'm38', name: 'MAQ 38', type: 'SANTONI SM8 TOP 2V', diam: 15, needles: 1344, gauge: 28 },
            { id: 'm37', name: 'MAQ 37', type: 'SANTONI SM8 TOP 2V', diam: 15, needles: 1344, gauge: 28 },
            { id: 'm29', name: 'MAQ 29', type: 'SANTONI SM8 EVO 4', diam: 16, needles: 1296, gauge: 26 },
            { id: 'm28', name: 'MAQ 28', type: 'SANTONI SM8 EVO 4', diam: 16, needles: 1296, gauge: 26 },
            { id: 'm27', name: 'MAQ 27', type: 'SANTONI SM8 EVO 4', diam: 15, needles: 1248, gauge: 26 },
            { id: 'm33', name: 'MAQ 33', type: 'SANTONI SM8 EVO 4', diam: 15, needles: 1344, gauge: 28 },
            { id: 'm1',  name: 'MAQ 1',  type: 'CIXING', diam: 14, needles: 1248, gauge: 28 },
            { id: 'm30', name: 'MAQ 30', type: 'CIXING GE82', diam: 14, needles: 1248, gauge: 28 },
            { id: 'm31', name: 'MAQ 31', type: 'CIXING GE82', diam: 14, needles: 1248, gauge: 28 },
            { id: 'm6',  name: 'MAQ 6',  type: 'CIXING GE82', diam: 14, needles: 1248, gauge: 28 },
            { id: 'm32', name: 'MAQ 32', type: 'CIXING GE82', diam: 14, needles: 1248, gauge: 28 },
            { id: 'm13', name: 'MAQ 13', type: 'SANTONI SM8 EVO 4', diam: 13, needles: 1056, gauge: 26 },
            { id: 'm12', name: 'MAQ 12', type: 'SANTONI SM8 EVO 4', diam: 13, needles: 1056, gauge: 26 },
            { id: 'm24', name: 'MAQ 24', type: 'SANTONI SM8 EVO 4', diam: 13, needles: 1056, gauge: 26 },
            { id: 'm8',  name: 'MAQ 8',  type: 'SANTONI SM8 TOP 2', diam: 13, needles: 1152, gauge: 28 },
        ];

        // Definimos calendario completo
        const ALL_ROWS = [
            'MIERCOLES 12', 'JUEVES 13', 'VIERNES 14', 'SABADO 15', 'DOMINGO 16',
            'LUNES 17', 'MARTES 18', 'MIERCOLES 19', 'JUEVES 20', 'VIERNES 21',
            'SABADO 22', 'DOMINGO 23', 'LUNES 24', 'MARTES 25', 'MIERCOLES 26',
            'JUEVES 27', 'VIERNES 28', 'SABADO 29', 'DOMINGO 30'
        ];

        // Definimos la "Semana Actual" para operadores/observadores
        const CURRENT_WEEK_ROWS = ALL_ROWS.slice(0, 7); // SimulaciÃ³n de semana actual

        // --- COMPONENTES ---

        const MachineIconImage = ({ className }) => {
            const [hasError, setHasError] = useState(false);
            const imageUrl = "https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.png";
            
            if (hasError) return <div className="text-xs text-gray-500"><i data-lucide="alert-circle" className="w-4 h-4"></i></div>;
            return <img src={imageUrl} className={className + " object-contain"} onError={() => setHasError(true)} />;
        };

        const LoginScreen = ({ setAuthenticatedUser }) => {
            const [pin, setPin] = useState('');
            const [error, setError] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                setError('');
                const user = USERS[pin];
                if (user) {
                    setAuthenticatedUser(user);
                    setPin(''); 
                } else {
                    setError('PIN incorrecto.');
                }
            };

            return (
                <div className="flex items-center justify-center h-screen bg-slate-50">
                    <div className="w-full max-w-sm p-8 bg-white rounded-2xl shadow-xl border border-slate-100">
                        <div className="flex flex-col items-center mb-8">
                            <div className="bg-blue-600 p-4 rounded-2xl text-white mb-4 shadow-lg shadow-blue-200">
                                <i data-lucide="shield-check" className="w-10 h-10"></i>
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800 tracking-tight">Acceso ProducciÃ³n</h2>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-5">
                            <input
                                type="password"
                                placeholder="Ingresa tu PIN"
                                maxLength="4"
                                value={pin}
                                onChange={(e) => setPin(e.target.value)}
                                className="w-full p-4 text-center text-3xl font-mono tracking-[0.5em] border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all"
                                required
                            />
                            {error && <p className="text-sm text-red-500 text-center font-medium animate-pulse">{error}</p>}
                            <button type="submit" className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-800 transition shadow-lg disabled:opacity-50" disabled={pin.length !== 4}>
                                INGRESAR SISTEMA
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const PlanningModal = ({ machine, rowId, currentData, onClose, onSave, allRows }) => {
            const [model, setModel] = useState(currentData?.derivedPlan?.plan_model || '');
            const [targetQty, setTargetQty] = useState(currentData?.derivedPlan?.plan_target_qty || '');
            const [timeMin, setTimeMin] = useState(currentData?.derivedPlan?.plan_time_min || '');
            const [hours, setHours] = useState(currentData?.derivedPlan?.plan_hours || 24);
            const [migrationMode, setMigrationMode] = useState(false);

            // Valores acumulados para mostrar progreso
            const accumulated = currentData?.accumulatedOfPlan || 0;
            const remaining = (Number(targetQty) || 0) - accumulated;

            const handleSave = () => {
                const data = {
                    plan_model: model || null,
                    plan_target_qty: Number(targetQty) || null,
                    plan_time_min: Number(timeMin) || null,
                    plan_hours: Number(hours) || null,
                };
                onSave(rowId, machine.id, data);
                onClose();
            };

            const handleMigrate = (targetMachineId) => {
                // LÃ³gica simple: Iniciar un "Nuevo Pedido" en otra mÃ¡quina con el remanente
                const data = {
                    plan_model: model,
                    plan_target_qty: remaining > 0 ? remaining : Number(targetQty),
                    plan_time_min: Number(timeMin),
                    plan_hours: 24
                };
                onSave(rowId, targetMachineId, data); // Guardar en la mÃ¡quina destino
                alert(`Pedido migrado a ${targetMachineId} con Ã©xito.`);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in duration-200" onClick={e => e.stopPropagation()}>
                        <div className="p-5 border-b flex justify-between items-center bg-slate-900 text-white">
                            <div>
                                <h3 className="text-lg font-bold flex items-center gap-2">
                                    <i data-lucide="clipboard-edit" className="w-5 h-5"></i>
                                    {migrationMode ? 'Migrar Pedido' : `Planificar: ${machine.name}`}
                                </h3>
                                <p className="text-xs text-slate-400">{rowId}</p>
                            </div>
                            <button onClick={onClose}><i data-lucide="x" className="w-6 h-6"></i></button>
                        </div>
                        
                        {!migrationMode ? (
                            <div className="p-6 space-y-5">
                                <div className="grid grid-cols-2 gap-4">
                                    <label className="block">
                                        <span className="text-xs font-bold text-slate-500 uppercase">Modelo</span>
                                        <input type="text" value={model} onChange={(e) => setModel(e.target.value)} className="mt-1 w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-semibold" placeholder="Ej: B001" />
                                    </label>
                                    <label className="block">
                                        <span className="text-xs font-bold text-slate-500 uppercase">Pedido Total (Pzas)</span>
                                        <input type="number" value={targetQty} onChange={(e) => setTargetQty(e.target.value)} className="mt-1 w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-semibold" />
                                    </label>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <label className="block">
                                        <span className="text-xs font-bold text-slate-500 uppercase">Minutos/Pieza</span>
                                        <input type="number" value={timeMin} onChange={(e) => setTimeMin(e.target.value)} className="mt-1 w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-semibold" />
                                    </label>
                                    <label className="block">
                                        <span className="text-xs font-bold text-slate-500 uppercase">Horas Turno</span>
                                        <select value={hours} onChange={(e) => setHours(e.target.value)} className="mt-1 w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none font-semibold">
                                            <option value={12}>12 Horas</option>
                                            <option value={24}>24 Horas</option>
                                        </select>
                                    </label>
                                </div>

                                {currentData?.derivedPlan && (
                                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                        <h4 className="text-sm font-bold text-blue-800 mb-2">Progreso del Pedido Actual</h4>
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="text-blue-600">Producido Acumulado:</span>
                                            <span className="font-bold">{accumulated} pzas</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-blue-600">Faltante:</span>
                                            <span className="font-bold">{Math.max(0, remaining)} pzas</span>
                                        </div>
                                        <div className="w-full bg-blue-200 h-2 rounded-full mt-2 overflow-hidden">
                                            <div 
                                                className="bg-blue-600 h-full transition-all duration-500" 
                                                style={{ width: `${Math.min(100, (accumulated / (targetQty || 1)) * 100)}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                )}

                                <div className="flex gap-3 pt-2">
                                    <button onClick={handleSave} className="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-green-200">
                                        {currentData?.isStartOfPlan ? 'Actualizar Pedido' : 'Iniciar Nuevo / Modificar'}
                                    </button>
                                    {currentData?.derivedPlan && (
                                        <button onClick={() => setMigrationMode(true)} className="px-4 py-3 bg-indigo-100 text-indigo-700 rounded-xl font-bold hover:bg-indigo-200 transition">
                                            <i data-lucide="arrow-right-left" className="w-5 h-5"></i>
                                        </button>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="p-6 space-y-4">
                                <p className="text-sm text-slate-600">Selecciona la mÃ¡quina a donde deseas transferir el restante de <b>{remaining}</b> piezas del modelo <b>{model}</b>.</p>
                                <div className="grid grid-cols-3 gap-2 max-h-60 overflow-y-auto p-1">
                                    {MACHINES.filter(m => m.id !== machine.id).map(m => (
                                        <button key={m.id} onClick={() => handleMigrate(m.id)} className="p-2 text-xs border rounded hover:bg-blue-50 hover:border-blue-300 text-left">
                                            <b>{m.name}</b><br/>{m.diam}"
                                        </button>
                                    ))}
                                </div>
                                <button onClick={() => setMigrationMode(false)} className="w-full mt-4 text-slate-500 hover:text-slate-800 text-sm font-semibold">Cancelar MigraciÃ³n</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [firebaseUser, setFirebaseUser] = useState(null);
            const [authenticatedUser, setAuthenticatedUser] = useState(null);
            const [productionData, setProductionData] = useState({});
            const [loading, setLoading] = useState(true);
            const [expandedMachineId, setExpandedMachineId] = useState(null);
            const [planningModal, setPlanningModal] = useState(null);

            // Cargar Iconos
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            // Auth Firebase
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, setFirebaseUser);
                signInAnonymously(auth).catch(console.error);
                return () => unsubscribe();
            }, []);

            // Data Realtime
            useEffect(() => {
                if (!firebaseUser) return;
                const unsubscribe = onSnapshot(collection(db, 'produccion_2025'), (snapshot) => {
                    const data = {};
                    snapshot.forEach((doc) => data[doc.id] = doc.data());
                    setProductionData(data);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [firebaseUser]);

            // --- LÃGICA CORE: PROCESAMIENTO DE HERENCIA (CASCADA) ---
            const processedData = useMemo(() => {
                const rows = [];
                // Estado corriente de cada mÃ¡quina { plan: Object, totalProduced: number, startRowIndex: number }
                const machineState = {}; 

                ALL_ROWS.forEach((rowId, index) => {
                    const rowData = {};
                    
                    MACHINES.forEach(machine => {
                        const rawCell = productionData[rowId]?.[machine.id] || {};
                        
                        // 1. Â¿Hay un NUEVO plan explÃ­cito en DB para este dÃ­a?
                        if (rawCell.plan_model) {
                            machineState[machine.id] = {
                                plan: { ...rawCell }, // { plan_model, plan_target_qty, ... }
                                accumulated: 0,
                                startRowIndex: index
                            };
                        }

                        // 2. Obtener el Plan Activo (El de hoy o el heredado)
                        const activeState = machineState[machine.id];
                        const activePlan = activeState ? activeState.plan : null;

                        // 3. Sumar producciÃ³n del dÃ­a al acumulado del pedido
                        const actualQty = Number(rawCell.actual) || 0;
                        if (activeState) {
                            activeState.accumulated += actualQty;
                        }

                        // 4. CÃ¡lculos para la celda actual
                        let cellCalculations = {};
                        if (activePlan) {
                            // Capacidad diaria teÃ³rica
                            const totalMinutes = (activePlan.plan_hours || 24) * 60;
                            const dailyTarget = activePlan.plan_time_min > 0 
                                ? Math.round(totalMinutes / activePlan.plan_time_min) 
                                : 0;
                            
                            // Progreso total del pedido
                            const totalTarget = activePlan.plan_target_qty || 1;
                            const totalProgressPercent = Math.min(100, ((activeState.accumulated) / totalTarget) * 100);

                            cellCalculations = {
                                derivedPlan: activePlan,
                                isStartOfPlan: !!rawCell.plan_model, // Â¿Es el dÃ­a donde se escribiÃ³ el plan?
                                dailyTarget: dailyTarget,
                                accumulatedOfPlan: activeState.accumulated,
                                totalProgressPercent: totalProgressPercent.toFixed(1)
                            };
                        }

                        rowData[machine.id] = {
                            ...rawCell,
                            ...cellCalculations
                        };
                    });
                    rows.push({ rowId, machines: rowData });
                });
                return rows;
            }, [productionData]);

            // --- GUARDADO ---
            const handleUpdate = useCallback(async (rowId, machineId, newData) => {
                if (!authenticatedUser) return;
                try {
                    const docRef = doc(db, 'produccion_2025', rowId);
                    // Preparamos la data. Si es actualizacion de 'actual', va directo.
                    // Si es plan, sobreescribe.
                    const payload = {};
                    Object.keys(newData).forEach(key => {
                        payload[`${machineId}.${key}`] = newData[key];
                    });
                    
                    await setDoc(docRef, payload, { merge: true });
                } catch (err) { console.error(err); }
            }, [authenticatedUser]);

            // --- RENDER ---
            if (!authenticatedUser) return <LoginScreen setAuthenticatedUser={setAuthenticatedUser} />;
            if (loading) return <div className="h-screen flex items-center justify-center"><i data-lucide="loader-2" className="animate-spin w-10 h-10 text-blue-600"></i></div>;

            // Filtro de filas segÃºn rol
            const canViewAll = [ROLES.ADMIN, ROLES.COMMENTATOR].includes(authenticatedUser.role);
            const visibleRowsData = processedData.filter(row => canViewAll || CURRENT_WEEK_ROWS.includes(row.rowId));

            return (
                <div className="min-h-screen flex flex-col font-sans">
                    {planningModal && (
                        <PlanningModal 
                            machine={MACHINES.find(m => m.id === planningModal.machineId)}
                            rowId={planningModal.rowId}
                            currentData={planningModal.data}
                            allRows={ALL_ROWS}
                            onClose={() => setPlanningModal(null)}
                            onSave={handleUpdate}
                        />
                    )}

                    <header className="bg-white border-b border-slate-200 sticky top-0 z-30 px-4 py-3 shadow-sm flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="bg-slate-900 text-white p-2 rounded-lg"><i data-lucide="factory" className="w-5 h-5"></i></div>
                            <div>
                                <h1 className="font-bold text-slate-800 leading-tight">Control de ProducciÃ³n</h1>
                                <p className="text-xs text-slate-500 font-medium">{authenticatedUser.name}</p>
                            </div>
                        </div>
                        <button onClick={() => setAuthenticatedUser(null)} className="text-slate-400 hover:text-red-500 transition"><i data-lucide="log-out" className="w-5 h-5"></i></button>
                    </header>

                    <main className="flex-1 overflow-auto p-4 custom-scrollbar">
                        <div className="bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden">
                            <div className="overflow-x-auto custom-scrollbar">
                                <table className="w-full border-collapse">
                                    <thead>
                                        <tr className="bg-slate-50 border-b border-slate-200 text-left">
                                            <th className="sticky left-0 z-20 bg-slate-50 p-3 min-w-[140px] border-r border-slate-200 shadow-sm">FECHA</th>
                                            {MACHINES.map(m => (
                                                <th key={m.id} className={`machine-col ${expandedMachineId === m.id ? 'expanded' : ''} p-2 border-r border-slate-100 align-top transition-all duration-300`}>
                                                    <button onClick={() => setExpandedMachineId(expandedMachineId === m.id ? null : m.id)} className="w-full flex flex-col items-center gap-1 hover:bg-slate-100 rounded p-1 transition">
                                                        <div className="w-8 h-8"><MachineIconImage className="w-full h-full" /></div>
                                                        <span className="text-xs font-black text-slate-700">{m.name.replace('MAQ ','')}</span>
                                                        {expandedMachineId === m.id && <span className="text-[10px] text-slate-400 font-normal">{m.type.split(' ')[0]}</span>}
                                                    </button>
                                                </th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {visibleRowsData.map((row, idx) => (
                                            <tr key={row.rowId} className={`border-b border-slate-100 hover:bg-slate-50 transition ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50/30'}`}>
                                                <td className="sticky left-0 z-10 bg-inherit p-3 border-r border-slate-200 text-xs font-bold text-slate-600 shadow-sm whitespace-nowrap">
                                                    {row.rowId}
                                                </td>
                                                {MACHINES.map(m => {
                                                    const cell = row.machines[m.id];
                                                    const isExpanded = expandedMachineId === m.id;
                                                    const canEdit = authenticatedUser.role !== ROLES.OBSERVER;
                                                    const canPlan = authenticatedUser.role === ROLES.ADMIN;
                                                    const hasPlan = !!cell.derivedPlan;

                                                    return (
                                                        <td key={m.id} className={`p-1 border-r border-slate-100 relative machine-col ${isExpanded ? 'expanded' : ''} transition-all duration-300 align-top`}>
                                                            <div className="flex flex-col h-full gap-1">
                                                                {/* Area de PlanificaciÃ³n (Visual) */}
                                                                <div className={`rounded text-[10px] p-1 flex justify-between items-start transition-colors ${hasPlan ? 'bg-blue-50/50' : 'bg-transparent'}`}>
                                                                    {hasPlan ? (
                                                                        <div className="flex-1 overflow-hidden">
                                                                            <div className="font-bold text-blue-800 truncate" title={cell.derivedPlan.plan_model}>{cell.derivedPlan.plan_model}</div>
                                                                            {/* Barra de Progreso del Pedido */}
                                                                            <div className="mt-1 w-full bg-blue-100 h-1.5 rounded-full overflow-hidden">
                                                                                <div className="bg-blue-500 h-full" style={{width: `${cell.totalProgressPercent}%`}}></div>
                                                                            </div>
                                                                            {isExpanded && (
                                                                                <div className="mt-1 text-slate-500">
                                                                                    Obj Dia: {cell.dailyTarget}<br/>
                                                                                    Llevamos: {cell.accumulatedOfPlan}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    ) : (
                                                                        <div className="h-4"></div>
                                                                    )}

                                                                    {/* BotÃ³n + para Admin (Nueva orden o Modificar) */}
                                                                    {canPlan && (
                                                                        <button 
                                                                            onClick={() => setPlanningModal({ machineId: m.id, rowId: row.rowId, data: cell })}
                                                                            className={`ml-1 w-5 h-5 flex items-center justify-center rounded hover:bg-slate-200 text-slate-400 hover:text-blue-600 transition ${!hasPlan ? 'opacity-30 hover:opacity-100' : ''}`}
                                                                            title="AÃ±adir/Modificar Plan"
                                                                        >
                                                                            <i data-lucide="plus" className="w-3 h-3"></i>
                                                                        </button>
                                                                    )}
                                                                </div>

                                                                {/* Input de ProducciÃ³n Real */}
                                                                <input 
                                                                    type="number" 
                                                                    value={cell.actual ?? ''}
                                                                    placeholder="-"
                                                                    className={`w-full text-center font-bold text-sm bg-transparent outline-none py-1 rounded ${cell.actual > 0 ? 'text-slate-800' : 'text-slate-300'} ${canEdit ? 'hover:bg-yellow-50 focus:bg-white focus:ring-1 focus:ring-blue-300' : ''}`}
                                                                    readOnly={!canEdit}
                                                                    onChange={(e) => canEdit && handleUpdate(row.rowId, m.id, { actual: Number(e.target.value) })}
                                                                />
                                                            </div>
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
